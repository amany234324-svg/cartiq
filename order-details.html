<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Details - Attire</title>
  <link rel="stylesheet" href="css/home.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .product-img { max-width: 80px; height: auto; object-fit: cover; border-radius: 6px; }
    .status-pending  { background-color: #ffc107; color: #212529; }
    .status-processing { background-color: #0dcaf0; color: white; }
    .status-shipped   { background-color: #198754; color: white; }
    .status-delivered { background-color: #198754; color: white; font-weight: bold; }
    .status-cancelled { background-color: #dc3545; color: white; }
  </style>
</head>
<body class="bg-light">

<div class="container my-5 pt-5">
  <h2 class="mb-4 fw-bold">Order Details</h2>

  <div id="loading" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Loading order details...</p>
  </div>

  <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

  <div class="card shadow-sm mb-4">
    <div class="card-body" id="orderInfo">
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Items in this Order</h5>
      <div id="orderItems" class="row g-3">
      </div>
    </div>
  </div>

  <a href="customer-order.html" class="btn btn-secondary mt-4">
    ← Back to My Orders
  </a>
</div>

<script type="module">
  import {getOrderById} from './data/orders.js'
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get("id");

  const orderInfo   = document.getElementById("orderInfo");
  const orderItems  = document.getElementById("orderItems");
  const loadingEl   = document.getElementById("loading");
  const errorEl     = document.getElementById("errorMessage");

  if (!orderId) {
    errorEl.textContent = "No order ID provided in the URL";
    errorEl.style.display = "block";
    return;
  }

  const API_BASE = "http://localhost:3000";

  loadingEl.style.display = "block";
  orderInfo.innerHTML = "";
  orderItems.innerHTML = "";

  try {

    const res = await getOrderById(orderId)
    if (res.status !== 'success') {
      throw new Error(res.message);
    }

    const order = await res.data;

    const date = new Date(order.createdAt).toLocaleDateString('en-GB', {
      day: 'numeric', month: 'short', year: 'numeric'
    });

    const statusClass = `status-${order.status}`;
    const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);

    orderInfo.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
          <h4 class="mb-1">Order #${order.id}</h4>
          <p class="text-muted mb-0">Placed on ${date}</p>
        </div>
        <span class="badge fs-6 px-3 py-2 ${statusClass}">
          ${statusText}
        </span>
      </div>

      <div class="row mb-3">
        <div class="col-sm-6">
          <strong>Total Amount:</strong><br>
          EGP ${Number(order.totalPrice || 0).toFixed(2)}
        </div>
        <div class="col-sm-6">
          <strong>Payment Method:</strong><br>
          ${order?.payment === 'cash' ? 'Cash on Delivery' : order?.payment || 'Not specified'}
        </div>
      </div>

      <hr>

      <h5 class="mt-4 mb-3">Shipping Address</h5>
      <address class="mb-0">
        ${order.shippingInfo?.fullName || 'N/A'}<br>
        ${order.shippingInfo?.address || 'N/A'}<br>
        ${order.shippingInfo?.city || ''} ${order.shippingInfo?.postalCode ? `- ${order.shippingInfo.postalCode}` : ''}<br>
        Phone: ${order.shippingInfo?.phone || 'N/A'}
      </address>
    `;

    if (!order.items || order.items.length === 0) {
      orderItems.innerHTML = '<p class="text-muted">No items found in this order.</p>';
    } else {
      orderItems.innerHTML = order.items.map(item => {
        if (typeof item === 'string') {
          return `
            <div class="col-12">
              <div class="border rounded p-3 bg-white">
                ${item}
              </div>
            </div>
          `;
        }

        return `
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body d-flex align-items-center">
                <img src="${item.image || 'https://via.placeholder.com/80'}" 
                     class="product-img me-3" 
                     alt="${item.name || 'Product'}">
                <div class="flex-grow-1">
                  <h6 class="mb-1">${item.name || 'Product #' + item.productId}</h6>
                  <div class="small text-muted">
                    Quantity: ${item.quantity || 1} × 
                    EGP ${Number(item.price || 0).toFixed(2)}
                  </div>
                </div>
                <div class="fw-bold ms-3">
                  EGP ${((item.price || 0) * (item.quantity || 1)).toFixed(2)}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

  } catch (err) {
    console.error("Error loading order:", err);
    errorEl.textContent = `Failed to load order details: ${err.message}`;
    errorEl.style.display = "block";
  } finally {
    loadingEl.style.display = "none";
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>