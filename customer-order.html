<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Orders - Attire</title>
    <link rel="stylesheet" href="css/home.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .order-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 20px;
        position: relative;
      }
      .delete-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        color: #dc3545;
        font-size: 1.4rem;
        cursor: pointer;
        background: none;
        border: none;
        transition: color 0.2s;
      }
      .delete-btn:hover {
        color: #c82333;
      }
      .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      }
      .badge-status {
        padding: 0.5em 0.8em;
        border-radius: 6px;
        font-weight: 500;
      }
      .bg-pending {
        background: #ffc107;
        color: #212529;
      }
      .bg-processing {
        background: #17a2b8;
        color: white;
      }
      .bg-shipped,
      .bg-paid {
        background: #0d6efd;
        color: white;
      }
      .bg-delivered {
        background: #28a745;
        color: white;
      }
      .bg-cancelled {
        background: #6c757d;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    <div class="container my-5 pt-5">
      <h1 class="text-center mb-5 fw-bold">My Orders</h1>

      <div class="empty-state" id="emptyState" style="display: none">
        <i class="fas fa-box-open fa-4x text-muted mb-4"></i>
        <h3>No orders yet</h3>
        <p class="text-muted mb-4">
          When you place an order, it will appear here.
        </p>
        <a href="collection.html" class="btn btn-primary px-4"
          >Start Shopping</a
        >
      </div>

      <div id="ordersList" class="row g-4"></div>
      <div id="loading" class="text-center my-5" style="display: none">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading your orders...</p>
      </div>
      <div
        id="errorMessage"
        class="alert alert-danger text-center my-4"
        style="display: none"
      ></div>
    </div>

    <script type="module">
      import { isAuthenticated, getCurrentUser, logout } from '../data/auth.js';
      import { updateCartCount } from './js/script.js';
      fetch('navbar.html')
        .then((response) => response.text())
        .then((data) => {
          document.getElementById('navbar-placeholder').innerHTML = data;
          updateUserUI();
          updateCartCount();
        })
        .catch((err) => console.error('Error loading navbar:', err));
      async function updateUserUI() {
        const auth = isAuthenticated();
        if (auth.status !== 'success') return;

        const userRes = await getCurrentUser();

        if (userRes.status === 'success') {
          const user = userRes.data;
          const firstName = user.name.split(' ')[0];

          // نبحث عن عنصر تسجيل الدخول فقط
          const authContainer = document.getElementById('auth-link');

          if (authContainer) {
            // نستبدل رابط "Login" فقط بالـ Dropdown، دون المساس بالأيقونات المجاورة
            authContainer.outerHTML = `
        <div class="dropdown d-inline-block">
          <button class="user-profile-btn dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="user-avatar">${firstName.charAt(0).toUpperCase()}</span>
            <span class="d-none d-md-inline ms-1">${firstName}</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2" aria-labelledby="userMenu">

              <a class="dropdown-item text-danger" href="javascript:void(0)" id="logoutBtn">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      `;
          }
        }

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
          e.preventDefault();
          const res = logout();
          if (res.status === 'success') {
            window.location.href = 'login.html';
          }
        });
      }
      import { getCurrentUserOrders, deleteOrderById } from './data/orders.js';
      const API_BASE = 'http://localhost:3000'; // URL JSON Server
      const ordersList = document.getElementById('ordersList');
      const emptyState = document.getElementById('emptyState');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('errorMessage');

      // ======== Load Orders ========
      async function loadOrders() {
        ordersList.innerHTML = '';
        emptyState.style.display = 'none';
        errorEl.style.display = 'none';
        loadingEl.style.display = 'block';

        try {
          // const res = await fetch(`${API_BASE}/orders`);
          const res = await getCurrentUserOrders();
          // const data = await res.json();
          const data = res.data;
          loadingEl.style.display = 'none';

          if (
            res.status !== 'success' ||
            !Array.isArray(data) ||
            data.length === 0
          ) {
            emptyState.style.display = 'block';
            return;
          }

          data.forEach((order) => {
            const date = new Date(order.createdAt).toLocaleDateString('en-GB', {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
            });
            const statusClass =
              {
                pending: 'bg-pending',
                processing: 'bg-processing',
                shipped: 'bg-shipped',
                paid: 'bg-paid',
                delivered: 'bg-delivered',
                cancelled: 'bg-cancelled',
              }[order.status.toLowerCase()] || 'bg-cancelled';

            const itemsList = order.items.map((item) => item.name).join('<br>');

            ordersList.innerHTML += `
        <div class="order-card col-12 col-md-6 col-lg-4">
          <button class="delete-btn" onclick="deleteOrder(${order.id})" title="Delete Order">

          </button>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-1">Order #${order.id}</h5>
              <small class="text-muted">Placed on ${date}</small>
            </div>
            <span class="badge-status ${statusClass}">
              ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
            </span>
          </div>

          <div class="mb-2"><strong>Total:</strong> EGP ${Number(order.totalPrice).toFixed(2)}</div>
          <div class="mb-2"><strong>Items:</strong><br>${itemsList || 'No item details'}</div>

          <a href="order-details.html?id=${order.id}" class="btn btn-sm btn-outline-primary">
            View Details
          </a>
        </div>
      `;
          });
        } catch (err) {
          console.error(err);
          loadingEl.style.display = 'none';
          errorEl.textContent = 'Failed to load orders from server';
          errorEl.style.display = 'block';
        }
      }

      // ======== DELETE ORDER ========
      // ======== DELETE ORDER ========
      window.deleteOrder = async function (orderId) {
        if (
          !confirm('Are you sure you want to delete this order permanently?')
        ) {
          return;
        }

        try {
          console.log(`Attempting to delete order #${orderId}`);

          // const res = await fetch(`${API_BASE}/orders/${orderId}`, {
          //   method: "DELETE",
          //   headers: {
          //     "Content-Type": "application/json"
          //   }
          // });

          const res = await deleteOrder(orderId);

          console.log('Delete response status:', res.status);

          if (res.status === 'success') {
            // نجاح → إعادة تحميل القائمة
            alert('Order deleted successfully');
            await loadOrders(); // انتظر إعادة التحميل
          } else if (res.status === 'fail') {
            // alert("Order not found (maybe already deleted)");
            alert(res.message);
            await loadOrders();
          } else {
            const errorText = await res.text().catch(() => 'Unknown error');
            console.error('Delete failed:', res.status, errorText);
            alert(`Failed to delete order (status ${res.status})`);
          }
        } catch (err) {
          console.error('Network / delete error:', err);
          alert('Error connecting to server. Is json-server running?');
        }
      };
      document.addEventListener('DOMContentLoaded', loadOrders);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
